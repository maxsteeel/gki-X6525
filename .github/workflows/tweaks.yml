name: Build GKI Kernel (test branch)
on:
  workflow_dispatch:
jobs:
  build:
    name: Build Kernel
    runs-on: buildjet-64vcpu-ubuntu-latest
    steps:
      - name: Clone Kernel Source with Submodules
        run: |
          git clone --recurse-submodules https://github.com/maxsteeel/android_kernel_unisoc -b temp common -j$(nproc --all)
      
      - name: Update KernelSU-Next
        run: |
          cd common/KernelSU-Next
          git checkout legacy
          cd ..

      - name: Build Kernel
        run: |
          cd common
          make O="out" test_defconfig
          make O="out" Image

      - name: Repack in AnyKernel3 zip
        run: |
          git clone https://github.com/maxsteeel/AnyKernel3
          cp -rf common/out/arch/arm64/boot/Image AnyKernel3

      - name: Upload Kernel (Image)
        uses: actions/upload-artifact@v4
        with:
          name: AnyKernel3-MaxKernel-temp
          path: AnyKernel3/*
